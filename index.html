<!DOCTYPE html>
<html>
<head>
  <title>Peta Interaktif UMKM - GeoJSON</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Leaflet CSS & JS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <!-- Plugin Geolocation -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet.locatecontrol/dist/L.Control.Locate.min.css" />
  <script src="https://unpkg.com/leaflet.locatecontrol/dist/L.Control.Locate.min.js"></script>

  <!-- Font Inter -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">

  <style>
    body, html {
      margin: 0; padding: 0; height: 100%; font-family: 'Inter', sans-serif;
    }
    #map {
      width: 100%; height: 100vh;
    }

    /* Sidebar container */
    .sidebar {
      position: absolute;
      bottom: 10px;
      left: 10px;
      width: 300px;
      max-height: 300px;
      background: white;
      box-shadow: 0 0 5px rgba(0,0,0,0.3);
      border-radius: 8px;
      overflow: hidden;
      font-size: 13px;
      z-index: 1000;
    }

    /* Header with toggle icon */
    .sidebar-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: #007BFF;
      color: #fff;
      padding: 8px 12px;
    }
    .sidebar-header span.title {
      font-weight: 600;
    }
    .sidebar-header span.toggle {
      cursor: pointer;
      font-size: 18px;
      user-select: none;
    }

    /* List */
    .sidebar-list {
      max-height: 260px;
      overflow-y: auto;
    }
    .entry {
      padding: 8px 12px;
      border-bottom: 1px solid #eee;
      cursor: pointer;
      text-transform: capitalize;
    }
    .entry:hover { background: #f5f5f5; }
    .entry div { margin: 2px 0; }
    .entry b { font-weight: 600; }

    /* WhatsApp button in popup */
    .whatsapp-btn {
      display: inline-block;
      background: #25D366;
      color: white;
      padding: 4px 8px;
      margin-top: 4px;
      border-radius: 4px;
      text-decoration: none;
      font-size: 12px;
    }

    /* Locate control flush with zoom */
    .leaflet-control-locate {
      margin-top: 0 !important;
    }

    /* Batas & marker styling */
    .leaflet-overlay-pane { z-index: 300 !important; }
    .leaflet-marker-pane  { z-index: 600 !important; }
    .leaflet-overlay-pane path {
      stroke-width: 1px !important;
      opacity: 0.6 !important;
    }
    .leaflet-marker-icon {
      transform: scale(0.8);
      transform-origin: center center;
    }

    /* Popup width + no wrap on link */
    .leaflet-popup-content-wrapper {
      max-width: 250px !important;
    }
    .leaflet-popup-content a[target="_blank"] {
      white-space: nowrap;
    }
  </style>
</head>
<body>

  <div class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <span class="title">Daftar UMKM</span>
      <span class="toggle" id="toggleBtn">â‰¡</span>
    </div>
    <div class="sidebar-list" id="list"></div>
  </div>

  <div id="map"></div>

  <script>
    // Setup map
    var map = L.map('map').setView([-7.2, 107.9], 11);

    // Basemaps
    var osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
    var sat = L.tileLayer(
      'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
      { attribution: 'Tiles &copy; Esri' }
    );
    var topo = L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png');
    L.control.layers({ 'OSM': osm, 'Satelit': sat, 'Medan': topo }).addTo(map);

    // Locate control (no gap)
    L.control.locate({ position: 'topright', strings: { title: 'Lokasi Saya' } }).addTo(map);

    // Icons, termasuk SEMEN baru
    var icons = {
      'SEMEN': L.icon({ iconUrl:'https://cdn-icons-png.flaticon.com/512/2329/2329178.png', iconSize:[25,25] }),
      'BANGUNAN': L.icon({ iconUrl:'https://cdn-icons-png.flaticon.com/512/69/69524.png', iconSize:[25,25] }),
      'default': L.icon({ iconUrl:'https://cdn-icons-png.flaticon.com/512/2609/2609282.png', iconSize:[25,25] })
    };
    function getIcon(type){ return icons[type?.toUpperCase()]||icons.default; }

    function createWhatsAppLink(phone){
      let num=phone.replace(/\D/g,'');
      if(num.startsWith('0')) num='62'+num.slice(1);
      return 'https://wa.me/'+num;
    }

    // Populate UMKM
    var listEl = document.getElementById('list'),
        counter = 1;
    fetch('Data.geojson').then(r=>r.json()).then(d=>{
      L.geoJSON(d, {
        pointToLayer:(f,latlng)=>L.marker(latlng,{icon:getIcon(f.properties.BARANG_UNG)}),
        onEachFeature:(f,layer)=>{
          let p=f.properties, ll=layer.getLatLng();
          let route='https://www.google.com/maps/dir/?api=1'
                   +'&destination='+ll.lat+','+ll.lng+'&travelmode=driving';
          let wa=p.NO__TLP?'<br><a class="whatsapp-btn" href="'+createWhatsAppLink(p.NO__TLP)+'" target="_blank">WA</a>':'';
          let popup=`<b>${p.NAMA_USAHA}</b><br>
                     Jenis: ${p.JENIS||'-'}<br>
                     Barang: ${p.BARANG_UNG}<br>
                     Alamat: ${p.ALAMAT}<br>
                     Pemilik: <b>${p.NAMA_PEMIL}</b>${wa}<br>
                     <a href="${route}" target="_blank">Rute</a>`;
          layer.bindPopup(popup);

          // sidebar entry
          let div=document.createElement('div');
          div.className='entry';
          div.innerHTML=`${counter}. ${p.NAMA_USAHA}
                         <div>Pemilik: <b>${p.NAMA_PEMIL}</b></div>
                         <div>${p.ALAMAT}</div>`;
          div.onclick=()=>{ map.setView(ll,15); layer.openPopup(); };
          listEl.appendChild(div);
          counter++;
        }
      }).addTo(map);
    });

    // Batas administrasi
    fetch('Batas Administrasi.geojson').then(r=>r.json()).then(d=>{
      L.geoJSON(d,{
        style:{color:'red',weight:2,fillOpacity:0},
        onEachFeature:(f,l)=>{
          let props=Object.entries(f.properties)
                          .map(([k,v])=>`<b>${k}</b>: ${v}`).join('<br>');
          l.bindPopup(props);
        }
      }).addTo(map);
    });

    // Toggle sidebar
    document.getElementById('toggleBtn').onclick = ()=>{
      let sb = document.getElementById('sidebar');
      sb.style.bottom = sb.style.bottom==='10px' ? '-350px' : '10px';
    };
  </script>

</body>
</html>
